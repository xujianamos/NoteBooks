# 日志上报方案

## 1.背景

当前日志系统使用 winston 将日志记录在本地 json 文件，存储在应用目录下。当用户遇到问题时，技术人员无法快速定位和查看错误日志。

## 2.需要收集的信息

1. 日志文件（logs/*）
2. 用户人
3. 任务JSON数据（业务订单号和业务订单号的所有子任务数据）
4. ai 做图信息(aiRetouchStorage.json)
5. 应用配置信息（appConfig.json）
6. 环境信息（操作系统版本、平台、应用版本、Node.js、Electron、平台架构、设备信息）
7. 网络状态信息（监测网络延迟）：通过 ping 常用服务器（如应用后端服务器、CDN 节点）获取网络延迟数据，同时记录网络连接类型（Wi-Fi / 有线网络）、IP 地址等信息，用于判断问题是否与网络环境相关，如网络延迟过高导致上传慢或者失败情况。

## 3.方案概览

### 方案一：集成第三方错误监控服务（Sentry）

Sentry 是一款专业的错误监控与跟踪工具，通过在应用中集成 Sentry SDK，可实时捕获应用运行过程中的错误事件（包括未捕获异常、手动上报的错误等），并自动将错误堆栈、用户环境、设备信息等上下文数据上报至 Sentry 服务器。技术人员可通过 Sentry 提供的 Web 控制台查看错误详情、聚合分析错误趋势、设置告警规则等。

优点：

- 开箱即用，接入成本低：提供完善的 SDK（支持 Electron、Node.js 等技术栈），集成过程仅需简单配置，无需从零开发监控系统。

- 自动聚合、过滤、告警：可根据错误类型、堆栈信息自动聚合相似错误，过滤重复日志，同时支持通过邮件、Slack 等渠道设置实时告警，确保技术人员及时获知严重错误。

- 支持错误堆栈、用户环境、设备信息等上下文：上报的错误数据附带完整的上下文信息，可快速定位错误发生的代码位置和运行环境，降低排查难度。

- 提供完善的错误分析界面：控制台支持错误趋势图表、用户分布、影响版本等多维度分析功能，便于团队从宏观层面掌握应用错误状况，优先解决高频、严重的问题。

缺点：

- 免费版有额度限制：免费套餐通常对每月上报的错误事件数量、日志存储时长有明确限制，当应用用户量增长或错误率上升时，可能面临额度不足的问题，需升级付费套餐或自行部署。

- 数据存储在第三方服务器：用户日志、错误信息等敏感数据存储在 Sentry 服务器，虽 Sentry 提供数据加密等安全措施，但仍存在数据隐私泄露的潜在风险，对于对数据安全性要求极高（如涉及用户敏感信息、商业机密）的场景，可能不符合数据本地化存储的合规要求。

### 方案二：日志文件手动上传（OSS）

基于阿里云 OSS云存储服务，在应用内开发 “日志上传” 功能模块。用户遇到问题后，可手动触发上传操作，应用将本地收集的日志文件（logs/*）、用户信息（userData.json）等各类信息打包为压缩文件（如 zip 格式），通过 HTTP/HTTPS 协议上传至指定的 OSS 存储桶。技术人员可通过云存储控制台或自定义的日志管理后台，根据用户标识、上传时间等条件查询并下载对应的日志压缩包，进行后续问题排查。

优点：

- 实现相对简单，保留完整日志：核心功能仅需开发文件打包、OSS 上传接口调用逻辑，技术难度较低；上传的是完整的本地日志文件，无数据丢失或筛选，可提供最全面的问题排查依据。

- 日志文件完整，便于后续分析：支持对历史日志文件进行长期存储，可用于后续的问题复盘、数据统计分析（如错误类型分布、高频问题总结）等场景。

缺点：

- 需要云存储服务：需依赖第三方云存储服务，长期使用会产生存储费用（按存储容量、流量等计费），随着日志文件数量和大小的增长，成本会逐渐上升。

- 日志文件较大，上传耗时：日志文件（尤其是长期未清理的日志）可能占用较大存储空间（如几十 MB 甚至上百 MB），在网络环境较差（如低带宽、高延迟）的情况下，上传过程耗时较长，可能导致用户放弃上传，影响日志收集成功率。

### 方案三：混合方案

结合方案一（Sentry 实时监控）和方案二（OSS 手动上传）的优势，构建 “实时监控 + 手动补传” 的混合日志上传体系。一方面，通过集成 Sentry SDK，实时捕获并上报应用运行过程中的关键错误（如崩溃、未捕获异常），确保技术人员快速获知紧急问题；另一方面，保留 OSS 手动上传功能，当 Sentry 上报的精简日志无法完整定位问题时，技术人员可指导用户通过手动上传功能提交完整的本地日志文件，进行深度排查。同时，可在应用内设置日志级别控制，将严重错误实时上报 Sentry，普通日志仅本地存储，待需要时手动上传，平衡实时性和日志完整性。

优点：

- 兼顾实时性和完整性：紧急、严重的错误通过 Sentry 实时上报，确保问题快速响应；复杂问题可通过手动上传获取完整日志，保证排查深度，避免单一方案的局限性。

- 关键错误实时上报：优先解决影响范围广、严重程度高的关键错误（如应用崩溃），最大程度降低用户体验受损程度。

- 提供用户主动上报功能：赋予用户主动反馈问题并提交完整日志的能力，尤其适用于 Sentry 未捕获到的偶发性、场景性问题，提高问题发现和解决的概率。

缺点：

- 实现复杂度较高：需同时开发和维护 Sentry 集成模块、OSS 手动上传模块，涉及两个不同系统的接口调用、数据格式处理，且需考虑两个模块的协同（如日志数据的一致性、上传状态的同步），增加了开发和测试工作量。

- 需要维护多个上报渠道：需分别维护 Sentry 服务的配置（如告警规则、数据存储周期）、OSS 存储的权限管理（如上传密钥、存储桶访问控制）、日志管理后台的查询功能（需同时支持 Sentry 数据和 OSS 日志文件的查询），运维成本较高。

### 方案四：基于现有埋点事件

在应用内将需要收集的日志信息（如错误信息、环境信息）封装为特定格式的埋点事件（如 “log_upload_event”），通过现有的 EventTracker 接口上报至 TraceH5 平台。技术人员可在 TraceH5 平台的事件分析界面，根据事件类型、用户标识、时间范围等条件筛选日志事件，查看相关信息并进行问题排查。

优点：

- 复用现有基础设施（EventTracker + TraceH5）：无需开发新的日志上传接口、存储系统和管理后台，直接利用已有的埋点体系，大幅降低开发成本和周期。

- 开发成本低：仅需在应用内开发日志信息到埋点事件的格式转换、事件发送逻辑，无需处理复杂的存储、查询功能，开发效率高。

- 统一的事件追踪体系：日志数据与用户行为数据、功能使用数据等统一存储在 TraceH5 平台，便于技术人员将问题日志与用户的操作行为进行关联分析（如用户在执行某操作后触发错误），更全面地还原问题场景。

缺点：

- 受限于现有系统的设计：埋点体系通常是为收集短文本、结构化的事件数据设计的，若日志文件较大（如几十 MB 的日志文件）或格式复杂（如非结构化的调试日志），可能超出埋点事件的存储容量或数据格式限制，导致日志信息无法完整上报。

- 可能不是专门为错误日志设计：TraceH5 平台的核心功能是事件统计分析，缺乏针对错误日志的专业处理能力，如错误堆栈解析、相似错误聚合、实时告警等，技术人员在排查错误时需手动筛选、分析大量事件数据，效率较低。

- 没有错误详细分析：无法提供类似 Sentry 的错误趋势图表、影响版本分析、用户分布等专业分析功能，难以从宏观层面掌握应用的错误状况，不利于团队制定针对性的问题优化策略。

## 推荐方案

综合各方案的优缺点、适用场景以及实际业务需求（需快速解决用户反馈问题、兼顾日志完整性和后续扩展性、平衡开发成本与数据安全性），**推荐优先采用 “方案二（日志文件手动上传（OSS））+ 方案一（集成第三方错误监控服务（Sentry））” 的分阶段落地策略**，即先通过方案二快速解决当前用户反馈问题难以定位的痛点，再通过方案一增强实时错误监控能力，具体推荐理由如下：

1. **解决当前核心痛点的紧迫性**：当前最突出的问题是用户遇到问题后，技术人员无法获取日志，导致问题定位困难。方案二（OSS 手动上传）实现难度低、开发周期短，快速为用户提供日志上传入口，解决 “无日志可查” 的现状，缓解当前的问题排查压力。

2. **兼顾日志完整性与数据安全性**：方案二上传的是完整的本地日志文件，可提供最全面的问题排查依据，且日志数据存储在自有可控的 OSS 存储桶中，符合数据安全和隐私保护的要求，避免第三方服务数据存储的合规风险，尤其适用于可能涉及用户敏感信息的场景。

3. **后续扩展性与体验优化需求**：随着用户量增长和业务复杂度提升，仅靠手动上传无法满足 “实时发现问题、快速响应” 的需求。方案一（Sentry）的实时监控、自动告警功能可弥补这一不足，在方案二落地后，通过集成 Sentry 可实现 “紧急错误实时告警、普通问题手动补传日志” 的互补模式，兼顾效率与完整性。

